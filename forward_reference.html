<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forward - Personal Management</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Vue Demi -->
    <script src="https://unpkg.com/vue-demi"></script>
    <!-- Pinia -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pinia/2.1.7/pinia.iife.js"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: {
                            850: '#1e293b',
                            900: '#0f172a',
                        }
                    },
                    keyframes: {
                        'fade-in': {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                         'scale-in': {
                            '0%': { opacity: '0', transform: 'scale(0.95)' },
                            '100%': { opacity: '1', transform: 'scale(1)' },
                        }
                    },
                    animation: {
                        'fade-in': 'fade-in 0.2s ease-out',
                        'scale-in': 'scale-in 0.2s ease-out',
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .glass-panel { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.05); }
    </style>
</head>
<body class="bg-slate-950 text-slate-200 font-sans antialiased h-screen overflow-hidden selection:bg-indigo-500 selection:text-white">

    <div id="app" class="h-full flex">
        <!-- Sidebar -->
        <aside class="w-20 lg:w-64 border-r border-slate-800 flex flex-col justify-between bg-slate-900/50 transition-all duration-300">
            <div>
                <div class="h-16 flex items-center justify-center lg:justify-start lg:px-6 border-b border-slate-800">
                    <div class="w-8 h-8 bg-indigo-500 rounded-lg flex items-center justify-center mr-0 lg:mr-3 shadow-lg shadow-indigo-500/20">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>
                    </div>
                    <span class="font-bold text-lg tracking-tight hidden lg:block">Forward</span>
                </div>
                
                <nav class="mt-6 flex flex-col gap-2 px-2">
                    <nav-item 
                        label="Focus" 
                        icon="target" 
                        :active="currentView === 'focus'" 
                        @click="currentView = 'focus'">
                    </nav-item>
                    <nav-item 
                        label="Calendario" 
                        icon="calendar" 
                        :active="currentView === 'calendar'" 
                        @click="currentView = 'calendar'">
                    </nav-item>
                    <nav-item 
                        label="Atemporal" 
                        icon="infinity" 
                        :active="currentView === 'timeless'" 
                        @click="currentView = 'timeless'">
                    </nav-item>
                </nav>
            </div>
            
            <div class="p-4 border-t border-slate-800">
                <div class="hidden lg:flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-slate-700"></div>
                    <div class="text-sm">
                        <p class="font-medium">Usuario</p>
                        <p class="text-xs text-slate-500">Pro Plan</p>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col h-full overflow-hidden relative">
            <!-- Header Mobile/Desktop -->
            <header class="h-16 border-b border-slate-800 flex items-center justify-between px-6 bg-slate-900/50 backdrop-blur-sm z-10">
                <h1 class="text-xl font-semibold capitalize">{{ viewTitle }}</h1>
                <div class="flex gap-3 items-center">
                    
                    <!-- SHOW ARCHIVED TOGGLE (Only in Timeless) -->
                    <div v-if="currentView === 'timeless'" class="flex items-center gap-2 mr-2">
                        <span class="text-xs font-medium text-slate-400">Mostrar Archivados</span>
                        <button 
                            @click="showArchivedItems = !showArchivedItems" 
                            class="relative inline-flex h-5 w-9 items-center rounded-full transition-colors focus:outline-none"
                            :class="showArchivedItems ? 'bg-indigo-600' : 'bg-slate-700'"
                        >
                            <span class="inline-block h-3 w-3 transform rounded-full bg-white transition-transform" :class="showArchivedItems ? 'translate-x-5' : 'translate-x-1'"></span>
                        </button>
                    </div>

                    <button @click="handleHeaderPlan" class="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2 shadow-lg shadow-indigo-500/20">
                        <icon-lucide name="plus" size="16"></icon-lucide>
                        <span class="hidden sm:inline">Plan</span>
                    </button>
                </div>
            </header>

            <!-- Dynamic Views -->
            <div class="flex-1 overflow-y-auto p-6 scroll-smooth bg-gradient-to-br from-slate-950 to-slate-900">
                
                <!-- VIEW: FOCUS (TODAY) -->
                <day-dashboard 
                    v-if="currentView === 'focus'"
                    :timeline="taskStore.todayTimeline"
                    :todos="taskStore.todayTodos"
                    :completed-timeline="taskStore.todayCompletedTimeline"
                    :completed-todos="taskStore.todayCompletedTodos"
                    :archived-timeline="taskStore.todayArchivedTimeline"
                    :archived-todos="taskStore.todayArchivedTodos"
                    :date-ref="todayIso"
                    @request-plan="(ctx, data) => openPlan(ctx, data)"
                    @schedule="(b) => openPlan('schedule', { block: b })"
                    @request-delete="initDelete"
                ></day-dashboard>

                <!-- VIEW: CALENDAR -->
                <div v-if="currentView === 'calendar'" class="h-full flex flex-col max-w-6xl mx-auto glass-panel rounded-2xl overflow-hidden">
                    
                    <!-- CALENDAR GRID (Default View) -->
                    <div v-if="!selectedDay" class="h-full flex flex-col">
                        <!-- Calendar Header -->
                        <div class="flex items-center justify-between p-4 border-b border-slate-700 bg-slate-800/50">
                            <button @click="changeMonth(-1)" class="p-2 hover:bg-slate-700 rounded-lg"><icon-lucide name="chevron-left" size="20"></icon-lucide></button>
                            <h2 class="text-lg font-semibold">{{ currentMonthName }} {{ currentYear }}</h2>
                            <button @click="changeMonth(1)" class="p-2 hover:bg-slate-700 rounded-lg"><icon-lucide name="chevron-right" size="20"></icon-lucide></button>
                        </div>
                        <!-- Week Days -->
                        <div class="grid grid-cols-7 border-b border-slate-700 bg-slate-900/50">
                            <div v-for="day in ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb']" :key="day" class="py-2 text-center text-xs font-medium text-slate-500 uppercase">
                                {{ day }}
                            </div>
                        </div>
                        <!-- Days Grid -->
                        <div class="grid grid-cols-7 grid-rows-5 flex-1 bg-slate-800 gap-[1px]">
                            <div 
                                v-for="(day, index) in calendarDays" 
                                :key="index"
                                @click="selectDay(day.dateString)"
                                class="bg-slate-900 min-h-[80px] p-2 relative group hover:bg-slate-800 transition-colors cursor-pointer"
                                :class="{'opacity-30': !day.isCurrentMonth, 'bg-indigo-900/20': day.isToday}"
                            >
                                <div class="flex justify-between items-start">
                                    <span class="text-sm font-medium z-10" :class="day.isToday ? 'text-indigo-400' : 'text-slate-400'">{{ day.dayNumber }}</span>
                                </div>
                                
                                <div class="flex flex-wrap content-start gap-1 mt-1">
                                    <!-- Pending Tasks (DOTS) -->
                                    <div 
                                        v-for="block in day.dots" 
                                        :key="'d'+block.id"
                                        class="w-1.5 h-1.5 rounded-full"
                                        :style="{ backgroundColor: getBlockColor(block) }"
                                        :title="block.title + ' (Pendiente)'"
                                    ></div>
                                    
                                    <!-- Completed Tasks (SQUARES) -->
                                    <div 
                                        v-for="block in day.squares" 
                                        :key="'s'+block.id" 
                                        class="w-2.5 h-2.5 rounded-[2px] transition-opacity duration-300"
                                        :style="{ 
                                            backgroundColor: getBlockColor(block),
                                            opacity: getBlockOpacity(block)
                                        }"
                                        :title="block.title + ' (Completada)' + (block.type === 'list' ? ' ' + getListProgress(block) : '')"
                                    ></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- SELECTED DAY VIEW (Replaces Grid) -->
                    <div v-else class="h-full flex flex-col p-2 animate-fade-in">
                        <!-- Drill-down Header -->
                        <div class="flex items-center gap-4 mb-2 pb-2 border-b border-slate-700">
                            <button @click="selectedDay = null" class="flex items-center gap-2 text-sm text-slate-400 hover:text-white transition-colors bg-slate-800 px-3 py-1.5 rounded-lg">
                                <icon-lucide name="chevron-left" size="16"></icon-lucide> Volver al Mes
                            </button>
                            <div>
                                <h2 class="text-xl font-semibold text-white">{{ formatDateFriendly(selectedDay) }}</h2>
                            </div>
                        </div>

                        <!-- Reuse DayDashboard Component -->
                        <day-dashboard 
                            :timeline="selectedDayTimeline"
                            :todos="selectedDayTodos"
                            :completed-timeline="selectedDayCompletedTimeline"
                            :completed-todos="selectedDayCompletedTodos"
                            :archived-timeline="selectedDayArchivedTimeline"
                            :archived-todos="selectedDayArchivedTodos"
                            :date-ref="selectedDay"
                            @request-plan="(ctx, data) => openPlan(ctx, data)"
                            @schedule="(b) => openPlan('schedule', { block: b })"
                            @request-delete="initDelete"
                        ></day-dashboard>
                    </div>

                </div>

                <!-- VIEW: TIMELESS (BACKLOG) -->
                <div v-if="currentView === 'timeless'" class="h-full flex flex-col">
                    <div class="flex gap-6 h-full overflow-x-auto pb-4 items-stretch px-2">
                        
                        <!-- Columns Loop -->
                        <div v-for="col in displayColumns" :key="col.id" class="flex flex-col glass-panel rounded-xl h-full min-w-[320px] w-full max-w-sm bg-slate-900/80 border-t-4" :style="{ borderColor: col.color }" :class="{'opacity-75 border-dashed': col.isArchived}">
                            <div class="p-4 border-b border-slate-800 flex justify-between items-center">
                                <h3 class="font-medium truncate pr-2 flex items-center gap-2">
                                    {{ col.title }}
                                    <span v-if="col.isArchived" class="text-[10px] text-amber-500 bg-amber-900/30 px-1.5 rounded border border-amber-900/50">Archivado</span>
                                </h3>
                                <div class="flex items-center gap-1">
                                    <!-- Archive/Unarchive Column -->
                                    <button @click="taskStore.toggleArchiveColumn(col.id)" :title="col.isArchived ? 'Desarchivar' : 'Archivar'" class="p-1.5 text-slate-500 hover:text-amber-400 hover:bg-slate-800 rounded transition-colors">
                                        <icon-lucide name="archive" size="14"></icon-lucide>
                                    </button>
                                    <!-- Permanent Delete Column -->
                                    <button @click="initDelete({ id: col.id, type: 'column', title: col.title })" title="Eliminar para siempre" class="p-1.5 text-slate-500 hover:text-red-400 hover:bg-slate-800 rounded transition-colors">
                                        <icon-lucide name="trash" size="14"></icon-lucide>
                                    </button>
                                </div>
                            </div>
                            <div class="flex-1 overflow-y-auto p-3 custom-scrollbar">
                                <div class="space-y-3">
                                    <!-- Use new @schedule listener here and pass to openPlan -->
                                    <block-item 
                                        v-for="block in taskStore.getBacklogByType(col.typeFilter)" 
                                        :key="block.id" 
                                        :block="block" 
                                        :is-backlog="true" 
                                        @schedule="(b) => openPlan('schedule', { block: b })"
                                        @request-delete="initDelete"
                                    ></block-item>
                                    
                                    <!-- Add Button -->
                                    <button @click="openPlan('column', { column: col })" class="w-full py-2 text-sm text-slate-500 border border-dashed border-slate-700 rounded-lg hover:text-slate-300 transition-colors" :style="{ borderColor: col.color, color: col.color }">
                                        + Agregar
                                    </button>
                                </div>

                                <!-- Completed Section for Backlog -->
                                <div v-if="taskStore.getCompletedBacklogByType(col.typeFilter).length > 0" class="mt-6 pt-4 border-t border-slate-700/50">
                                    <h3 class="text-xs text-slate-500 font-medium mb-3 uppercase tracking-wider">Completadas</h3>
                                    <div class="space-y-3 opacity-60">
                                        <block-item v-for="block in taskStore.getCompletedBacklogByType(col.typeFilter)" :key="block.id" :block="block" :is-backlog="true" @request-delete="initDelete"></block-item>
                                    </div>
                                </div>

                                <!-- Archived Section for Backlog (Controlled by Toggle) -->
                                <div v-if="showArchivedItems && taskStore.getArchivedBacklogByType(col.typeFilter).length > 0" class="mt-4 pt-4 border-t border-slate-700/50">
                                    <h3 class="text-xs text-slate-600 font-medium mb-3 uppercase tracking-wider flex items-center gap-1">
                                        <icon-lucide name="archive" size="12"></icon-lucide> Archivadas
                                    </h3>
                                    <div class="space-y-3 opacity-40 hover:opacity-80 transition-opacity">
                                        <block-item v-for="block in taskStore.getArchivedBacklogByType(col.typeFilter)" :key="block.id" :block="block" :is-backlog="true" @request-delete="initDelete"></block-item>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- NEW COLUMN PLACEHOLDER CARD -->
                        <button @click="showColumnModal = true" class="flex flex-col items-center justify-center glass-panel rounded-xl h-full min-w-[320px] w-full max-w-sm bg-slate-900/40 border-2 border-dashed border-slate-800 hover:bg-slate-800/50 hover:border-slate-600 transition-all group cursor-pointer">
                            <div class="w-12 h-12 rounded-full bg-slate-800 flex items-center justify-center mb-3 group-hover:scale-110 transition-transform shadow-lg">
                                <icon-lucide name="plus" size="24" class="text-slate-500 group-hover:text-white transition-colors"></icon-lucide>
                            </div>
                            <span class="text-slate-500 font-medium group-hover:text-white transition-colors">Añadir Nueva Columna</span>
                        </button>

                    </div>
                </div>

            </div>
        </main>

        <!-- DELETE CONFIRMATION MODAL -->
        <div v-if="deleteModal.show" class="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm animate-fade-in">
            <div class="bg-slate-900 border border-slate-700 w-full max-w-sm rounded-2xl shadow-2xl p-6 text-center animate-scale-in">
                <div class="w-12 h-12 bg-red-500/10 rounded-full flex items-center justify-center mx-auto mb-4">
                    <icon-lucide name="trash" size="24" class="text-red-500"></icon-lucide>
                </div>
                <h3 class="text-lg font-bold text-white mb-2">¿Estás seguro?</h3>
                <p class="text-slate-400 text-sm mb-6">
                    Se eliminará <strong class="text-slate-200">"{{ deleteModal.title }}"</strong> para siempre. Esta acción no se puede deshacer.
                </p>
                <div class="flex gap-3 justify-center">
                    <button @click="deleteModal.show = false" class="px-4 py-2 text-sm text-slate-300 hover:text-white bg-slate-800 hover:bg-slate-700 rounded-lg transition-colors">Cancelar</button>
                    <button @click="executeDelete" class="px-4 py-2 text-sm text-white bg-red-600 hover:bg-red-500 rounded-lg shadow-lg shadow-red-900/20 transition-colors">Eliminar</button>
                </div>
            </div>
        </div>

        <!-- CREATE MODAL -->
        <div v-if="showModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
            <div class="bg-slate-900 border border-slate-700 w-full max-w-md rounded-2xl shadow-2xl overflow-hidden animate-fade-in flex flex-col max-h-[90vh]">
                <div class="p-4 border-b border-slate-800 flex justify-between items-center">
                    <h3 class="font-semibold text-white">Plan</h3>
                    <button @click="showModal = false" class="text-slate-400 hover:text-white"><icon-lucide name="x" size="20"></icon-lucide></button>
                </div>
                <div class="p-6 space-y-5 overflow-y-auto">
                    <!-- Title -->
                    <div>
                        <input v-model="newBlock.title" type="text" placeholder="Título" class="w-full bg-transparent border-0 border-b border-slate-700 px-0 py-2 text-lg text-white placeholder-slate-500 focus:outline-none focus:border-indigo-500 transition-colors" autofocus>
                    </div>

                     <!-- Description -->
                     <div>
                        <textarea v-model="newBlock.description" rows="2" placeholder="Descripción (opcional)..." class="w-full bg-slate-800/50 border border-slate-700 rounded-lg px-3 py-2 text-sm text-white focus:outline-none focus:ring-1 focus:ring-indigo-500 resize-none"></textarea>
                    </div>

                    <!-- Checklist Section -->
                    <div class="space-y-2">
                        <label class="block text-xs font-medium text-slate-400 uppercase tracking-wide">Lista de Items</label>
                        <div v-for="(item, index) in newBlock.listItems" :key="index" class="flex gap-2">
                            <div class="mt-2 w-4 h-4 rounded-sm border border-slate-600 flex-shrink-0"></div>
                            <input v-model="item.text" type="text" class="flex-1 bg-transparent border-0 border-b border-slate-700/50 py-1 text-sm focus:outline-none focus:border-indigo-500" placeholder="Elemento de lista">
                            <button @click="removeListItem(index)" class="text-slate-500 hover:text-red-400"><icon-lucide name="x" size="14"></icon-lucide></button>
                        </div>
                        <button @click="addListItem" class="text-xs text-indigo-400 hover:text-indigo-300 flex items-center gap-1 font-medium mt-1">
                            <icon-lucide name="plus" size="12"></icon-lucide> Agregar item a lista
                        </button>
                    </div>

                    <!-- CATEGORY TOGGLE -->
                    <div class="pt-2 border-t border-slate-800/50">
                        <div class="flex items-center justify-between mb-3" :class="{'opacity-50': isCategoryLocked}">
                            <span class="text-sm font-medium text-slate-300">¿Agregar categoría?</span>
                            <button 
                                @click="hasCategory = !hasCategory" 
                                :disabled="isCategoryLocked"
                                class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 focus:ring-offset-slate-900"
                                :class="[hasCategory ? 'bg-indigo-600' : 'bg-slate-700', isCategoryLocked ? 'cursor-not-allowed' : '']"
                            >
                                <span class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform" :class="hasCategory ? 'translate-x-6' : 'translate-x-1'"></span>
                            </button>
                        </div>
                        
                        <div v-if="hasCategory" class="space-y-3 animate-fade-in mb-4 bg-slate-800/30 p-3 rounded-lg">
                            <div>
                                <label class="block text-[10px] text-slate-400 mb-1 uppercase">Categoría</label>
                                <select v-model="selectedCategoryId" class="w-full bg-slate-800 border border-slate-700 rounded px-2 py-1.5 text-sm text-white focus:outline-none focus:border-indigo-500">
                                    <option v-for="col in taskStore.columns" :key="col.id" :value="col.id">{{ col.title }}</option>
                                    <option value="NEW">+ Crear nueva...</option>
                                </select>
                            </div>

                            <div v-if="selectedCategoryId === 'NEW'" class="animate-fade-in space-y-3 pt-1">
                                <div>
                                    <label class="block text-[10px] text-slate-400 mb-1 uppercase">Nombre de Categoría</label>
                                    <input v-model="customCategoryTitle" type="text" placeholder="Ej: Universidad" class="w-full bg-slate-800 border border-slate-700 rounded px-2 py-1.5 text-sm text-white focus:outline-none focus:border-indigo-500">
                                </div>
                                <div>
                                    <label class="block text-[10px] text-slate-400 mb-1 uppercase">Color</label>
                                    <input v-model="customCategoryColor" type="color" class="w-full h-8 bg-slate-800 border border-slate-700 rounded cursor-pointer">
                                </div>
                            </div>
                            <div v-else-if="selectedCategoryId" class="animate-fade-in pt-1">
                                <label class="block text-[10px] text-slate-400 mb-1 uppercase">Color (Asignado)</label>
                                <div class="flex items-center gap-2">
                                    <div class="w-6 h-6 rounded border border-slate-600" :style="{ backgroundColor: selectedCategoryColor }"></div>
                                    <span class="text-xs text-slate-500">{{ selectedCategoryColor }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Meta Controls (Date/Time) -->
                    <div class="pt-2 border-t border-slate-800/50">
                        <!-- Date Toggle -->
                        <div class="flex items-center justify-between mb-3" :class="{'opacity-50': isDateDisabled}">
                            <span class="text-sm font-medium text-slate-300">¿Asignar Fecha?</span>
                            <button 
                                @click="toggleTimeless" 
                                :disabled="isDateDisabled"
                                class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 focus:ring-offset-slate-900"
                                :class="[!isTimeless ? 'bg-indigo-600' : 'bg-slate-700', isDateDisabled ? 'cursor-not-allowed' : '']"
                            >
                                <span class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform" :class="!isTimeless ? 'translate-x-6' : 'translate-x-1'"></span>
                            </button>
                        </div>

                        <!-- Date Inputs -->
                        <div v-if="!isTimeless" class="space-y-4 animate-fade-in bg-slate-800/30 p-3 rounded-lg">
                            <div class="flex gap-3">
                                <div class="flex-1">
                                    <label class="block text-[10px] text-slate-400 mb-1 uppercase">Fecha</label>
                                    <input v-model="newBlock.date" type="date" :disabled="isDateLocked" class="w-full bg-slate-800 border border-slate-700 rounded px-2 py-1.5 text-sm text-white focus:outline-none focus:border-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed">
                                </div>
                            </div>
                            
                            <!-- TOGGLE TIME -->
                            <div class="flex items-center justify-between" :class="{'opacity-50': isTimeDisabled}">
                                <span class="text-xs font-medium text-slate-400">¿Hora Específica?</span>
                                <div class="flex items-center gap-3">
                                    <button 
                                        @click="hasTime = !hasTime" 
                                        :disabled="isTimeDisabled"
                                        class="relative inline-flex h-5 w-9 items-center rounded-full transition-colors focus:outline-none"
                                        :class="[hasTime ? 'bg-indigo-600' : 'bg-slate-700', isTimeDisabled ? 'cursor-not-allowed' : '']"
                                    >
                                        <span class="inline-block h-3 w-3 transform rounded-full bg-white transition-transform" :class="hasTime ? 'translate-x-5' : 'translate-x-1'"></span>
                                    </button>
                                </div>
                            </div>

                            <div v-if="hasTime" class="animate-fade-in">
                                <input v-model="newBlock.time" type="time" class="w-full bg-slate-800 border border-slate-700 rounded px-2 py-1.5 text-sm text-white focus:outline-none focus:border-indigo-500">
                            </div>
                        </div>

                        <!-- Backlog Message -->
                        <div v-else class="p-3 bg-slate-800/50 rounded-lg border border-slate-700/50 text-xs text-slate-400 flex items-center justify-center gap-2 animate-fade-in">
                            <icon-lucide name="infinity" size="14"></icon-lucide>
                            <span>Se guardará en <strong>Atemporal</strong></span>
                        </div>
                    </div>
                </div>
                <div class="p-4 bg-slate-800/50 flex justify-end gap-2 border-t border-slate-800">
                    <button @click="showModal = false" class="px-4 py-2 text-sm text-slate-300 hover:text-white transition-colors">Cancelar</button>
                    <button @click="saveNewBlock" class="px-6 py-2 text-sm bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg font-medium shadow-lg shadow-indigo-500/20 transition-all transform active:scale-95">Guardar</button>
                </div>
            </div>
        </div>

        <!-- NEW COLUMN MODAL -->
        <div v-if="showColumnModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
             <div class="bg-slate-900 border border-slate-700 w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden animate-fade-in">
                <div class="p-4 border-b border-slate-800 flex justify-between items-center">
                    <h3 class="font-semibold text-white">Nueva Columna</h3>
                    <button @click="showColumnModal = false" class="text-slate-400 hover:text-white"><icon-lucide name="x" size="20"></icon-lucide></button>
                </div>
                <div class="p-6 space-y-4">
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Título de la Columna</label>
                        <input v-model="newColumn.title" type="text" placeholder="Ej: Proyectos" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Color (Hex)</label>
                        <input v-model="newColumn.color" type="color" class="w-full h-10 bg-slate-800 border border-slate-700 rounded-lg cursor-pointer">
                    </div>
                </div>
                <div class="p-4 bg-slate-800/50 flex justify-end gap-2">
                    <button @click="showColumnModal = false" class="px-4 py-2 text-sm text-slate-300 hover:text-white">Cancelar</button>
                    <button @click="saveNewColumn" class="px-4 py-2 text-sm bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg font-medium">Crear</button>
                </div>
             </div>
        </div>

    </div>

    <!-- VUE APPLICATION LOGIC -->
    <script>
        // Check for dependencies immediately
        if (typeof Vue === 'undefined' || typeof Pinia === 'undefined') {
            console.error('Critical Error: Vue or Pinia failed to load.');
        }

        const { createApp, ref, computed, watch, onMounted, reactive } = Vue;
        const { createPinia, defineStore, storeToRefs } = Pinia;

        // --- UTILS ---
        const generateId = () => Date.now().toString(36) + Math.random().toString(36).substr(2);
        const generateSlug = (text) => text.toLowerCase().trim().replace(/\s+/g, '-') + '-' + Date.now().toString(36).substr(-4);
        
        // Helper to get local date string YYYY-MM-DD
        const getLocalToday = () => {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        // Helper to prevent crashes from bad localStorage data
        const safeLoad = (key, fallback) => {
            try {
                const saved = localStorage.getItem(key);
                if (!saved) return fallback;
                const parsed = JSON.parse(saved);
                // Ensure strict array check for lists
                if (Array.isArray(fallback) && !Array.isArray(parsed)) {
                    console.warn(`Data mismatch for ${key}, resetting to default.`);
                    return fallback;
                }
                return parsed;
            } catch (e) {
                console.error(`Resetting corrupted data for ${key}`, e);
                return fallback;
            }
        };
        
        // --- ICONS COMPONENT (Lightweight wrapper) ---
        const IconLucide = {
            props: ['name', 'size'],
            template: `
                <svg :width="size || 24" :height="size || 24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path v-if="name==='target'" d="M12 2L2 7l10 5 10-5-10-5z M2 17l10 5 10-5 M2 12l10 5 10-5"></path>
                    <path v-if="name==='calendar'" d="M19 4H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2z M16 2v4 M8 2v4 M3 10h18"></path>
                    <path v-if="name==='infinity'" d="M12 12c-2.3 2.3-2.3 6 0 8.3s6 2.3 8.3 0c2.3-2.3 2.3-6 0-8.3m-8.3 0c-2.3-2.3-2.3-6 0-8.3s-6-2.3-8.3 0c-2.3 2.3-2.3 6 0 8.3"></path>
                    <path v-if="name==='plus'" d="M12 5v14M5 12h14"></path>
                    <path v-if="name==='clock'" d="M12 22a10 10 0 1 0 0-20 10 10 0 0 0 0 20z M12 6v6l4 2"></path>
                    <path v-if="name==='check-square'" d="M9 11l3 3L22 4 M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
                    <path v-if="name==='chevron-left'" d="M15 18l-6-6 6-6"></path>
                    <path v-if="name==='chevron-right'" d="M9 18l6-6-6-6"></path>
                    <path v-if="name==='x'" d="M18 6L6 18M6 6l12 12"></path>
                    <path v-if="name==='copy'" d="M8 2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h11a2 2 0 0 0 2-2v-3 M16 4h2a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-2"></path>
                    <path v-if="name==='arrow-right-circle'" d="M12 22a10 10 0 1 0 0-20 10 10 0 0 0 0 20z M12 16l4-4-4-4 M8 12h8"></path>
                    <path v-if="name==='trash'" d="M3 6h18 M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    <path v-if="name==='archive'" d="M21 8v13H3V8 M1 3h22v5H1V3z M10 12h4"></path>
                </svg>
            `
        }

        // --- NEW COMPONENT: PlanButton (Refactored) ---
        const PlanButton = {
            props: ['label', 'variant', 'icon'],
            components: { IconLucide },
            template: `
                <button 
                    class="flex items-center gap-2 rounded-lg text-sm font-medium transition-colors"
                    :class="[
                        variant === 'primary' ? 'bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 shadow-lg shadow-indigo-500/20' : '',
                        variant === 'minimal' ? 'text-xs bg-indigo-600/20 text-indigo-400 hover:bg-indigo-600 hover:text-white px-2 py-1 border border-indigo-600/30' : '',
                        variant === 'minimal-slate' ? 'text-xs bg-slate-700/50 text-slate-300 hover:bg-slate-700 hover:text-white px-2 py-1 border border-slate-600/50' : '',
                        variant === 'dashed' ? 'w-full py-2 text-slate-500 border border-dashed border-slate-700 hover:text-slate-300' : ''
                    ]"
                    @click="$emit('click')"
                >
                    <icon-lucide v-if="icon" :name="icon" :size="variant && variant.includes('minimal') ? 12 : 16"></icon-lucide>
                    <span :class="{ 'hidden sm:inline': variant === 'primary' }">{{ label }}</span>
                </button>
            `
        }

        // --- COMPONENTS ---
        const NavItem = {
            props: ['label', 'icon', 'active'],
            components: { IconLucide },
            template: `
                <button 
                    class="w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all duration-200 group"
                    :class="active ? 'bg-indigo-600 text-white shadow-md shadow-indigo-900/20' : 'text-slate-400 hover:bg-slate-800 hover:text-slate-100'"
                >
                    <icon-lucide :name="icon" :class="active ? 'text-white' : 'text-slate-400 group-hover:text-slate-200'"></icon-lucide>
                    <span class="font-medium text-sm hidden lg:block">{{ label }}</span>
                </button>
            `
        }

        const BlockItem = {
            props: ['block', 'isBacklog'],
            components: { IconLucide },
            emits: ['schedule', 'request-delete'],
            setup(props, { emit }) {
                const store = useTaskStore();
                const showActions = ref(false);
                const toggle = () => { store.toggleComplete(props.block.id); };
                const duplicate = () => { store.duplicateBlock(props.block.id); showActions.value = false; };
                const schedule = () => { emit('schedule', props.block); showActions.value = false; };
                const archive = () => { store.toggleArchive(props.block.id); showActions.value = false; };
                
                // Emits request-delete to parent (App)
                const requestDelete = () => { 
                     emit('request-delete', { id: props.block.id, title: props.block.title, type: 'block' }); 
                };
                
                const isList = computed(() => Array.isArray(props.block.content));
                const listItems = computed(() => Array.isArray(props.block.content) ? props.block.content : []);
                
                const toggleSubItem = (idx) => {
                    const newContent = [...listItems.value];
                    newContent[idx].done = !newContent[idx].done;
                    store.updateBlock(props.block.id, { content: newContent });
                };

                return { 
                    toggle, duplicate, schedule, archive, requestDelete,
                    showActions, isList, listItems, toggleSubItem 
                }
            },
            template: `
                <div class="group relative bg-slate-800/50 hover:bg-slate-800 border border-slate-700/50 hover:border-slate-600 rounded-lg p-3 transition-all duration-200 shadow-sm"
                     @mouseenter="showActions = true" @mouseleave="showActions = false">
                    <div class="flex items-start gap-3">
                        <button 
                            @click="toggle" 
                            class="mt-1 w-5 h-5 rounded border flex items-center justify-center transition-colors" 
                            :class="block.isCompleted ? 'bg-emerald-500 border-emerald-500' : 'border-slate-500 hover:border-indigo-400'"
                        >
                            <icon-lucide v-if="block.isCompleted" name="x" size="12" class="text-white transform rotate-45" style="transform: rotate(0deg) !important; stroke-width: 4px"></icon-lucide>
                        </button>
                        <div class="flex-1 min-w-0">
                            <h4 class="text-sm font-medium truncate transition-all" :class="block.isCompleted ? 'text-slate-500 line-through' : 'text-slate-200'">{{ block.title }}</h4>
                             <p v-if="block.description" class="text-xs text-slate-500 truncate mt-0.5">{{ block.description }}</p>

                            <div class="flex gap-2 mt-1">
                                <span v-if="block.time" class="text-[10px] bg-indigo-900/30 text-indigo-300 px-1.5 py-0.5 rounded border border-indigo-900/50">{{ block.time }}</span>
                                <span v-if="block.type !== 'task'" class="text-[10px] bg-slate-700 text-slate-400 px-1.5 py-0.5 rounded capitalize">{{ block.type }}</span>
                                <span v-if="block.isArchived" class="text-[10px] bg-amber-900/30 text-amber-500 px-1.5 py-0.5 rounded border border-amber-900/50">Archivado</span>
                            </div>
                            <div v-if="isList && listItems.length > 0" class="mt-2 space-y-1">
                                <div v-for="(item, idx) in listItems" :key="idx" @click.stop="toggleSubItem(idx)" class="flex items-center gap-2 text-xs text-slate-400 hover:text-slate-200 cursor-pointer">
                                    <div class="w-3 h-3 border rounded border-slate-600" :class="{'bg-slate-600': item.done}"></div>
                                    <span :class="{'line-through opacity-50': item.done}">{{ item.text }}</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Actions Overlay -->
                        <div v-show="showActions" class="flex items-center gap-1 bg-slate-900 rounded-md p-1 shadow-lg absolute top-2 right-2 border border-slate-700 animate-fade-in z-20">
                            <button @click.stop="duplicate" title="Duplicar" class="p-1 hover:text-indigo-400 text-slate-400"><icon-lucide name="copy" size="14"></icon-lucide></button>
                            <button @click.stop="schedule" title="Agendar" class="p-1 hover:text-emerald-400 text-slate-400"><icon-lucide name="calendar" size="14"></icon-lucide></button>
                            <button @click.stop="archive" :title="block.isArchived ? 'Desarchivar' : 'Archivar'" class="p-1 hover:text-amber-400 text-slate-400"><icon-lucide name="archive" size="14"></icon-lucide></button>
                            <button @click.stop="requestDelete" title="Borrar" class="p-1 hover:text-red-400 text-slate-400"><icon-lucide name="trash" size="14"></icon-lucide></button>
                        </div>
                    </div>
                </div>
            `
        }

        // --- REFACTORED SHARED COMPONENT: DAY DASHBOARD ---
        const DayDashboard = {
            props: {
                timeline: { type: Array, default: () => [] },
                todos: { type: Array, default: () => [] },
                completedTimeline: { type: Array, default: () => [] },
                completedTodos: { type: Array, default: () => [] },
                archivedTimeline: { type: Array, default: () => [] },
                archivedTodos: { type: Array, default: () => [] },
                dateRef: String
            },
            components: { BlockItem, IconLucide, PlanButton },
            emits: ['request-plan', 'schedule', 'request-delete'],
            template: `
                <div class="h-full grid grid-cols-1 lg:grid-cols-2 gap-8 max-w-7xl mx-auto">
                    <!-- Left: Timeline (Agenda - HAS TIME) -->
                    <div class="flex flex-col h-full glass-panel rounded-2xl p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-slate-400 text-sm font-medium uppercase tracking-wider flex items-center gap-2">
                                <icon-lucide name="clock" size="16"></icon-lucide> Agenda
                            </h2>
                            <plan-button 
                                variant="minimal" 
                                label="+ Agregar" 
                                @click="$emit('request-plan', 'agenda', { date: dateRef })"
                            ></plan-button>
                        </div>
                        
                        <div class="flex-1 overflow-y-auto space-y-4 pr-2 custom-scrollbar">
                            <div v-if="timeline.length === 0 && completedTimeline.length === 0 && archivedTimeline.length === 0" class="text-center py-10 text-slate-500 italic">
                                Nada agendado con hora.
                            </div>
                            <div v-for="block in timeline" :key="block.id" class="relative pl-6 border-l border-slate-700 pb-6 last:pb-0">
                                <div class="absolute -left-[5px] top-1 w-2.5 h-2.5 rounded-full bg-indigo-500 ring-4 ring-slate-900"></div>
                                <span class="text-xs font-mono text-indigo-400 mb-1 block">{{ block.time }}</span>
                                <block-item :block="block" @schedule="$emit('schedule', $event)" @request-delete="$emit('request-delete', $event)"></block-item>
                            </div>

                            <!-- Agenda Completed Section -->
                            <div v-if="completedTimeline.length > 0" class="mt-8 pt-4 border-t border-slate-700/50">
                                <h3 class="text-xs text-slate-500 font-medium mb-3 uppercase tracking-wider">Completadas</h3>
                                <div class="space-y-4 opacity-60">
                                    <div v-for="block in completedTimeline" :key="block.id" class="relative pl-6 border-l border-slate-700 pb-6 last:pb-0">
                                        <div class="absolute -left-[5px] top-1 w-2.5 h-2.5 rounded-full bg-slate-600 ring-4 ring-slate-900"></div>
                                        <span class="text-xs font-mono text-slate-500 mb-1 block">{{ block.time }}</span>
                                        <block-item :block="block" @schedule="$emit('schedule', $event)" @request-delete="$emit('request-delete', $event)"></block-item>
                                    </div>
                                </div>
                            </div>

                            <!-- Agenda Archived Section -->
                            <div v-if="archivedTimeline.length > 0" class="mt-8 pt-4 border-t border-slate-700/50">
                                <h3 class="text-xs text-slate-600 font-medium mb-3 uppercase tracking-wider flex items-center gap-1">
                                    <icon-lucide name="archive" size="12"></icon-lucide> Archivadas
                                </h3>
                                <div class="space-y-4 opacity-40 hover:opacity-80 transition-opacity">
                                    <div v-for="block in archivedTimeline" :key="block.id" class="relative pl-6 border-l border-slate-700 pb-6 last:pb-0">
                                        <div class="absolute -left-[5px] top-1 w-2.5 h-2.5 rounded-full bg-slate-800 ring-4 ring-slate-900"></div>
                                        <span class="text-xs font-mono text-slate-600 mb-1 block">{{ block.time }}</span>
                                        <block-item :block="block" @schedule="$emit('schedule', $event)" @request-delete="$emit('request-delete', $event)"></block-item>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right: To-Do (NO TIME) -->
                    <div class="flex flex-col h-full glass-panel rounded-2xl p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-slate-400 text-sm font-medium uppercase tracking-wider flex items-center gap-2">
                                <icon-lucide name="check-square" size="16"></icon-lucide> Tareas del Día
                            </h2>
                             <plan-button 
                                variant="minimal-slate" 
                                label="+ Agregar" 
                                @click="$emit('request-plan', 'todo', { date: dateRef })"
                            ></plan-button>
                        </div>

                        <div class="flex-1 overflow-y-auto space-y-3 pr-2 custom-scrollbar">
                            <div v-if="todos.length === 0 && completedTodos.length === 0 && archivedTodos.length === 0" class="text-center py-10 text-slate-500 italic">
                                No hay tareas generales pendientes.
                            </div>
                            <block-item v-for="block in todos" :key="block.id" :block="block" @schedule="$emit('schedule', $event)" @request-delete="$emit('request-delete', $event)"></block-item>
                            
                            <!-- Completed Section -->
                            <div v-if="completedTodos.length > 0" class="mt-8 pt-4 border-t border-slate-700/50">
                                <h3 class="text-xs text-slate-500 font-medium mb-3 uppercase tracking-wider">Completadas</h3>
                                <div class="space-y-3 opacity-60">
                                    <block-item v-for="block in completedTodos" :key="block.id" :block="block" @schedule="$emit('schedule', $event)" @request-delete="$emit('request-delete', $event)"></block-item>
                                </div>
                            </div>

                            <!-- Archived Section -->
                            <div v-if="archivedTodos.length > 0" class="mt-8 pt-4 border-t border-slate-700/50">
                                <h3 class="text-xs text-slate-600 font-medium mb-3 uppercase tracking-wider flex items-center gap-1">
                                    <icon-lucide name="archive" size="12"></icon-lucide> Archivadas
                                </h3>
                                <div class="space-y-3 opacity-40 hover:opacity-80 transition-opacity">
                                    <block-item v-for="block in archivedTodos" :key="block.id" :block="block" @schedule="$emit('schedule', $event)" @request-delete="$emit('request-delete', $event)"></block-item>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `
        };

        // --- PINIA STORE ---
        const useTaskStore = defineStore('tasks', {
            state: () => ({
                // Use safeLoad to prevent JSON parse errors from corrupt localStorage
                blocks: safeLoad('lifeos_blocks', [
                    { id: '1', type: 'task', title: 'Revisar emails importantes', description: '', date: getLocalToday(), time: '09:00', isCompleted: false, isArchived: false, isDeleted: false },
                    { id: '2', type: 'list', title: 'Compras Supermercado', description: 'Para la cena de hoy', content: [{text: 'Leche', done: false}, {text: 'Café', done: true}], date: null, time: null, isCompleted: false, isArchived: false, isDeleted: false },
                    { id: '3', type: 'idea', title: 'App de recetas con IA', description: '', date: null, time: null, isCompleted: false, isArchived: false, isDeleted: false },
                ]),
                columns: safeLoad('lifeos_columns', [
                    { id: 'c1', title: 'Ideas & Futuro', typeFilter: 'idea', color: '#10b981', isArchived: false }, 
                    { id: 'c2', title: 'Listas (Películas, Libros)', typeFilter: 'list', color: '#3b82f6', isArchived: false }, 
                    { id: 'c3', title: 'Notas & Journaling', typeFilter: 'note', color: '#a855f7', isArchived: false }  // Purple
                ])
            }),
            getters: {
                activeColumns: (state) => state.columns.filter(c => !c.isArchived),
                archivedColumnsList: (state) => state.columns.filter(c => c.isArchived),
                
                todayBlocks: (state) => {
                    const today = getLocalToday();
                    return state.blocks.filter(b => b.date === today && !b.isArchived);
                },
                todayTimeline: (state) => {
                    const today = getLocalToday();
                    // Strict: Must have date AND time, active, not archived
                    return state.blocks
                        .filter(b => b.date === today && b.time && !b.isCompleted && !b.isArchived && !b.isDeleted)
                        .sort((a, b) => a.time.localeCompare(b.time));
                },
                todayTodos: (state) => {
                    const today = getLocalToday();
                    // Strict: Must have date AND time is NULL/Empty, active, not archived
                    return state.blocks.filter(b => b.date === today && !b.time && !b.isCompleted && !b.isArchived && !b.isDeleted);
                },
                // Updated: Completed Timeline Items Only
                todayCompletedTimeline: (state) => {
                    const today = getLocalToday();
                    return state.blocks.filter(b => b.date === today && b.isCompleted && b.time && !b.isArchived && !b.isDeleted);
                },
                // Updated: Completed Todos Only (No Time)
                todayCompletedTodos: (state) => {
                    const today = getLocalToday();
                    return state.blocks.filter(b => b.date === today && b.isCompleted && !b.time && !b.isArchived && !b.isDeleted);
                },
                // NEW: Archived Getters for Today
                todayArchivedTimeline: (state) => {
                    const today = getLocalToday();
                    return state.blocks.filter(b => b.date === today && b.isArchived && b.time && !b.isDeleted);
                },
                todayArchivedTodos: (state) => {
                    const today = getLocalToday();
                    return state.blocks.filter(b => b.date === today && b.isArchived && !b.time && !b.isDeleted);
                },

                getBacklogByType: (state) => (type) => {
                    return state.blocks.filter(b => !b.date && b.type === type && !b.isCompleted && !b.isArchived && !b.isDeleted);
                },
                // ADD THIS:
                getCompletedBacklogByType: (state) => (type) => {
                    return state.blocks.filter(b => !b.date && b.type === type && b.isCompleted && !b.isArchived && !b.isDeleted);
                },
                // NEW: Archived Backlog
                getArchivedBacklogByType: (state) => (type) => {
                    return state.blocks.filter(b => !b.date && b.type === type && b.isArchived && !b.isDeleted);
                },

                // For Day Preview Modal
                getBlocksByDate: (state) => (date) => {
                    return state.blocks.filter(b => b.date === date && !b.isArchived && !b.isDeleted);
                },
                // New: Split completed getters for any date
                getCompletedTimelineByDate: (state) => (date) => {
                    return state.blocks.filter(b => b.date === date && b.isCompleted && b.time && !b.isArchived && !b.isDeleted);
                },
                getCompletedTodosByDate: (state) => (date) => {
                    return state.blocks.filter(b => b.date === date && b.isCompleted && !b.time && !b.isArchived && !b.isDeleted);
                },
                // NEW: Split ARCHIVED getters for any date
                getArchivedTimelineByDate: (state) => (date) => {
                    return state.blocks.filter(b => b.date === date && b.isArchived && b.time && !b.isDeleted);
                },
                getArchivedTodosByDate: (state) => (date) => {
                    return state.blocks.filter(b => b.date === date && b.isArchived && !b.time && !b.isDeleted);
                },
                // Add specific getters for the calendar logic if needed, but existing getBlocksByDate works fine now
                // We will rely on getCompletedTimelineByDate etc. in the App setup
                getTimelineByDate: (state) => (date) => {
                     return state.blocks.filter(b => b.date === date && b.time && !b.isCompleted && !b.isArchived && !b.isDeleted).sort((a, b) => a.time.localeCompare(b.time));
                },
                getTodosByDate: (state) => (date) => {
                     return state.blocks.filter(b => b.date === date && !b.time && !b.isCompleted && !b.isArchived && !b.isDeleted);
                }
            },
            actions: {
                addBlock(block) {
                    this.blocks.push({ id: generateId(), isCompleted: false, isArchived: false, isDeleted: false, ...block });
                    this.persist();
                },
                updateBlock(id, updates) {
                    const idx = this.blocks.findIndex(b => b.id === id);
                    if (idx !== -1) { this.blocks[idx] = { ...this.blocks[idx], ...updates }; this.persist(); }
                },
                toggleComplete(id) {
                    const block = this.blocks.find(b => b.id === id);
                    if (block) { 
                        block.isCompleted = !block.isCompleted; 
                        // Set completedAt
                        if (block.isCompleted) {
                            block.completedAt = getLocalToday();
                        } else {
                            block.completedAt = null;
                        }
                        this.persist(); 
                    }
                },
                toggleArchive(id) {
                    const block = this.blocks.find(b => b.id === id);
                    if (block) { block.isArchived = !block.isArchived; this.persist(); }
                },
                deleteBlock(id) {
                    // Hard Delete
                    this.blocks = this.blocks.filter(b => b.id !== id);
                    this.persist();
                },
                duplicateBlock(id) {
                    const original = this.blocks.find(b => b.id === id);
                    if (original) {
                        const copy = JSON.parse(JSON.stringify(original));
                        copy.id = generateId();
                        copy.title = `${copy.title} (Copia)`;
                        copy.isCompleted = false;
                        copy.isArchived = false;
                        copy.completedAt = null;
                        if(Array.isArray(copy.content)) copy.content.forEach(i => i.done = false);
                        this.blocks.push(copy);
                        this.persist();
                    }
                },
                // Columns
                addColumn(col) {
                    this.columns.push({ id: generateId(), isArchived: false, ...col });
                    this.persistColumns();
                },
                toggleArchiveColumn(id) {
                    const col = this.columns.find(c => c.id === id);
                    if(col) { col.isArchived = !col.isArchived; this.persistColumns(); }
                },
                deleteColumn(id) {
                    // Hard Delete Column
                    this.columns = this.columns.filter(c => c.id !== id);
                    this.persistColumns();
                },
                persist() { localStorage.setItem('lifeos_blocks', JSON.stringify(this.blocks)); },
                persistColumns() { localStorage.setItem('lifeos_columns', JSON.stringify(this.columns)); }
            }
        });

        const App = {
            components: { NavItem, BlockItem, IconLucide, DayDashboard, PlanButton },
            setup() {
                const store = useTaskStore();
                const currentView = ref('focus');
                
                // Modal States
                const showModal = ref(false);
                const showColumnModal = ref(false);
                // New: Delete Confirmation Modal State
                const showDeleteModal = ref(false);
                const deleteTargetId = ref(null);
                const deleteTargetType = ref(null); // 'block' or 'column'
                const deleteTargetTitle = ref(''); // For display
                const deleteModal = reactive({ // Using reactive object for safer template access
                    show: false,
                    title: '',
                    id: null,
                    type: null
                });

                const selectedDay = ref(null);
                const editingId = ref(null);
                
                // Toggle for Archived in Timeless
                const showArchivedItems = ref(false);

                // Form States
                const isTimeless = ref(false);
                const hasTime = ref(false);
                
                const hasCategory = ref(false); 
                const selectedCategoryId = ref('');
                const customCategoryTitle = ref('');
                const customCategoryColor = ref('#6366f1');
                const isCategoryLocked = ref(false);
                const isDateDisabled = ref(false);
                const isDateLocked = ref(false);
                const isTimeDisabled = ref(false);

                // New Block Structure
                const newBlock = ref({ title: '', description: '', type: 'task', date: '', time: '', listItems: [] });
                const newColumn = ref({ title: '', typeFilter: '', color: '#6366f1' });

                const todayIso = computed(() => getLocalToday());

                const selectedCategoryColor = computed(() => {
                    if (selectedCategoryId.value === 'NEW') return customCategoryColor.value;
                    const col = store.columns.find(c => c.id === selectedCategoryId.value);
                    return col ? col.color : '#6366f1';
                });

                const viewTitle = computed(() => {
                    const titles = { focus: 'Mi Día', calendar: 'Planificación', timeless: 'Backlog & Ideas' };
                    return titles[currentView.value];
                });

                // Display Columns in Timeless (Active + Archived if toggle ON)
                const displayColumns = computed(() => {
                    if (showArchivedItems.value) {
                         return store.columns; // Show all (active and archived)
                    }
                    return store.activeColumns;
                });

                // Calendar Logic
                const today = new Date();
                const currentMonth = ref(today.getMonth());
                const currentYear = ref(today.getFullYear());
                const currentMonthName = computed(() => new Date(currentYear.value, currentMonth.value).toLocaleString('es-ES', { month: 'long' }));

                // HELPER: Get block color for calendar grid
                const getBlockColor = (block) => {
                    const col = store.columns.find(c => c.typeFilter === block.type);
                    return col ? col.color : '#64748b'; // Default slate-500
                };

                // HELPER: Get block opacity for calendar grid (List progress)
                const getBlockOpacity = (block) => {
                    if (block.type !== 'list' || !Array.isArray(block.content) || block.content.length === 0) {
                        return 1; // Full opacity for simple tasks or empty lists
                    }
                    // For lists: Base opacity 0.4 + percentage * 0.6
                    const total = block.content.length;
                    const checked = block.content.filter(i => i.done).length;
                    if (total === 0) return 1;
                    return 0.4 + (checked / total) * 0.6;
                };
                
                // HELPER: Get list progress string
                const getListProgress = (block) => {
                     if (!Array.isArray(block.content)) return '';
                     const total = block.content.length;
                     const checked = block.content.filter(i => i.done).length;
                     return `${checked}/${total}`;
                };

                const calendarDays = computed(() => {
                    const days = [];
                    const firstDay = new Date(currentYear.value, currentMonth.value, 1).getDay();
                    const daysInMonth = new Date(currentYear.value, currentMonth.value + 1, 0).getDate();
                    for (let i = 0; i < firstDay; i++) days.push({ dayNumber: '', isCurrentMonth: false, taskCount: 0 });
                    for (let i = 1; i <= daysInMonth; i++) {
                        const d = `${currentYear.value}-${String(currentMonth.value + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                        
                        // Dots: Pending tasks scheduled for this day
                        const dots = store.blocks.filter(b => {
                            return !b.isCompleted && !b.isArchived && b.date === d;
                        });

                        // Squares: Completed tasks
                        // Case 1: Scheduled task completed -> stays on scheduled date
                        // Case 2: Timeless task completed -> appears on completion date
                        const squares = store.blocks.filter(b => {
                            if (!b.isCompleted || b.isArchived) return false;
                            
                            if (b.date) {
                                // Scheduled task: Show on scheduled date
                                return b.date === d;
                            } else {
                                // Timeless task: Show on completedAt date
                                return b.completedAt === d;
                            }
                        });

                        days.push({ 
                            dayNumber: i, 
                            dateString: d, 
                            isCurrentMonth: true, 
                            isToday: d === getLocalToday(), 
                            dots: dots,
                            squares: squares
                        });
                    }
                    return days;
                });

                const changeMonth = (d) => {
                    let nm = currentMonth.value + d;
                    if (nm > 11) { nm = 0; currentYear.value++; } else if (nm < 0) { nm = 11; currentYear.value--; }
                    currentMonth.value = nm;
                };

                // --- CENTRALIZED ACTION HANDLER ---
                const openPlan = (context, data = {}) => {
                    // Reset Basic State
                    newBlock.value = { title: '', description: '', listItems: [], type: 'task', date: '', time: '' };
                    editingId.value = null;
                    
                    // Reset Flags
                    hasCategory.value = false;
                    selectedCategoryId.value = '';
                    customCategoryTitle.value = '';
                    customCategoryColor.value = '#6366f1';
                    isCategoryLocked.value = false;
                    
                    // Defaults
                    let defaultDate = '';
                    let defaultTime = false;
                    let defaultTimeless = false;
                    let defaultHasCategory = false;
                    let defaultCatId = '';

                    switch(context) {
                        case 'header':
                            if (currentView.value === 'focus') {
                                defaultDate = todayIso.value;
                                defaultTime = false; 
                                defaultTimeless = false;
                            } else if (currentView.value === 'calendar') {
                                if (selectedDay.value) {
                                    defaultDate = selectedDay.value;
                                } else {
                                    // Default to 1st of month if navigating
                                    const now = new Date();
                                    if (currentYear.value === now.getFullYear() && currentMonth.value === now.getMonth()) {
                                        defaultDate = getLocalToday();
                                    } else {
                                        const y = currentYear.value;
                                        const m = String(currentMonth.value + 1).padStart(2, '0');
                                        defaultDate = `${y}-${m}-01`;
                                    }
                                }
                                defaultTime = false;
                                defaultTimeless = false;
                            } else if (currentView.value === 'timeless') {
                                defaultDate = '';
                                defaultTime = false;
                                defaultTimeless = true;
                                defaultHasCategory = true;
                            }
                            break;

                        case 'agenda':
                            defaultDate = data.date;
                            defaultTime = true;
                            defaultTimeless = false;
                            
                            // Fix: Default time value if not present
                            newBlock.value.time = '09:00'; 
                            break;

                        case 'todo':
                            defaultDate = data.date;
                            defaultTime = false;
                            defaultTimeless = false;
                            break;

                        case 'column': // Timeless Column
                            defaultDate = '';
                            defaultTime = false;
                            defaultTimeless = true;
                            defaultHasCategory = true;
                            defaultCatId = data.column.id;
                            if (data.column) newBlock.value.type = data.column.typeFilter; // Inherit type
                            break;
                            
                        case 'schedule': // Schedule existing item
                            const block = data.block;
                            editingId.value = block.id;
                            newBlock.value = { 
                                ...block,
                                listItems: Array.isArray(block.content) ? JSON.parse(JSON.stringify(block.content)) : []
                            };
                            
                            // Scheduling defaults: Use existing date, or today if none
                            if (block.date) {
                                defaultDate = block.date;
                            } else {
                                // If timeless item being scheduled, default to today
                                defaultDate = getLocalToday();
                            }

                            defaultTimeless = false; 
                            defaultTime = !!block.time; // If block has time, toggle ON
                            
                            // Check for category
                            const col = store.columns.find(c => c.typeFilter === block.type);
                            if(col) {
                                defaultHasCategory = true;
                                defaultCatId = col.id;
                            }
                            break;
                    }

                    // Apply Configuration
                    newBlock.value.date = defaultDate;
                    isTimeless.value = defaultTimeless;
                    hasTime.value = defaultTime;
                    hasCategory.value = defaultHasCategory;
                    if(defaultCatId) selectedCategoryId.value = defaultCatId;

                    // Final safety for timeless
                    if(isTimeless.value) newBlock.value.date = '';

                    // Open Modal
                    showModal.value = true;
                };

                // --- DELETE HANDLERS (Unified) ---
                const initDelete = (payload) => {
                    deleteModal.id = payload.id;
                    deleteModal.title = payload.title;
                    deleteModal.type = payload.type;
                    deleteModal.show = true;
                };

                // --- EXECUTE DELETE (After Confirmation) ---
                const executeDelete = () => {
                    if (deleteModal.type === 'block') {
                        store.deleteBlock(deleteModal.id);
                    } else if (deleteModal.type === 'column') {
                        store.deleteColumn(deleteModal.id); 
                    }
                    deleteModal.show = false;
                    deleteModal.id = null;
                    deleteModal.type = null;
                    deleteModal.title = '';
                };

                const toggleTimeless = () => {
                    isTimeless.value = !isTimeless.value;
                    if(isTimeless.value) hasTime.value = false;
                    if(!isTimeless.value && !newBlock.value.date) {
                         if (selectedDay.value && currentView.value === 'calendar') {
                             newBlock.value.date = selectedDay.value;
                         } else {
                             newBlock.value.date = getLocalToday();
                         }
                    }
                }

                const addListItem = () => { newBlock.value.listItems.push({ text: '', done: false }); };
                const removeListItem = (index) => { newBlock.value.listItems.splice(index, 1); };

                const saveNewBlock = () => {
                    if (!newBlock.value.title) return;
                    
                    const finalDate = isTimeless.value ? null : (newBlock.value.date || getLocalToday());
                    let finalTime = null;
                    if (!isTimeless.value && hasTime.value) {
                         finalTime = newBlock.value.time ? newBlock.value.time : '12:00';
                    }
                    
                    let finalType = newBlock.value.type;
                    if (hasCategory.value) {
                        if (selectedCategoryId.value === 'NEW' && customCategoryTitle.value) {
                            const typeSlug = generateSlug(customCategoryTitle.value);
                            store.addColumn({
                                title: customCategoryTitle.value,
                                typeFilter: typeSlug,
                                color: customCategoryColor.value
                            });
                            finalType = typeSlug;
                        } else if (selectedCategoryId.value && selectedCategoryId.value !== 'NEW') {
                            const col = store.columns.find(c => c.id === selectedCategoryId.value);
                            if (col) finalType = col.typeFilter;
                        }
                    }

                    const payload = {
                        title: newBlock.value.title,
                        description: newBlock.value.description,
                        date: finalDate,
                        time: finalTime,
                        type: finalType
                    };

                    if (newBlock.value.listItems.length > 0) {
                        payload.content = newBlock.value.listItems;
                    } else {
                        payload.content = '';
                    }

                    if (editingId.value) {
                        store.updateBlock(editingId.value, payload);
                    } else {
                        store.addBlock(payload);
                    }
                    
                    showModal.value = false;
                    editingId.value = null;
                };

                const selectDay = (date) => {
                    if(!date) return;
                    selectedDay.value = date;
                };

                const formatDateFriendly = (d) => {
                    if(!d) return '';
                    const date = new Date(d);
                    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                    return new Date(d + 'T12:00:00').toLocaleDateString('es-ES', options);
                };
                
                const saveNewColumn = () => {
                    if(!newColumn.value.title) return;
                    const typeSlug = generateSlug(newColumn.value.title);
                    store.addColumn({
                        title: newColumn.value.title,
                        typeFilter: typeSlug,
                        color: newColumn.value.color
                    });
                    newColumn.value = { title: '', typeFilter: '', color: '#6366f1' };
                    showColumnModal.value = false;
                };

                const handleHeaderPlan = () => openPlan('header');

                watch(currentView, () => selectedDay.value = null);

                // --- COMPUTED PROPERTIES FOR SELECTED DAY (Moved to use Store Getters) ---
                const selectedDayTimeline = computed(() => {
                    if (!selectedDay.value) return [];
                    return store.getTimelineByDate(selectedDay.value);
                });
                const selectedDayTodos = computed(() => {
                    if (!selectedDay.value) return [];
                    return store.getTodosByDate(selectedDay.value);
                });
                const selectedDayCompletedTimeline = computed(() => {
                    if (!selectedDay.value) return [];
                    return store.getCompletedTimelineByDate(selectedDay.value);
                });
                const selectedDayCompletedTodos = computed(() => {
                    if (!selectedDay.value) return [];
                    return store.getCompletedTodosByDate(selectedDay.value);
                });
                const selectedDayArchivedTimeline = computed(() => {
                    if (!selectedDay.value) return [];
                    return store.getArchivedTimelineByDate(selectedDay.value);
                });
                const selectedDayArchivedTodos = computed(() => {
                    if (!selectedDay.value) return [];
                    return store.getArchivedTodosByDate(selectedDay.value);
                });


                return {
                    taskStore: store, currentView, viewTitle, 
                    // Modals
                    showModal, showColumnModal, deleteModal, // Using single object for delete modal state
                    // Forms
                    newBlock, newColumn, isTimeless, hasTime,
                    hasCategory, selectedCategoryId, customCategoryTitle, customCategoryColor, selectedCategoryColor, isCategoryLocked,
                    // Actions
                    openPlan, saveNewBlock, toggleTimeless, saveNewColumn, 
                    initDelete, executeDelete, // Unified delete handlers
                    addListItem, removeListItem, handleHeaderPlan,
                    // Calendar
                    currentMonthName, currentYear, calendarDays, changeMonth, 
                    selectDay, selectedDay, 
                    
                    selectedDayTimeline, selectedDayTodos, selectedDayCompletedTimeline, selectedDayCompletedTodos,
                    selectedDayArchivedTimeline, selectedDayArchivedTodos,
                    // Calendar Helpers
                    getBlockColor, getBlockOpacity, getListProgress,

                    formatDateFriendly,
                    todayIso,
                    showArchivedItems, displayColumns, 
                    isTimeDisabled, isDateDisabled, isDateLocked
                }
            }
        };

        try {
            const app = createApp(App);
            app.use(createPinia());
            app.mount('#app');
        } catch (error) {
            console.error("Mount Error:", error);
        }
    </script>
</body>
</html>